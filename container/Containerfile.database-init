# Database Initialization Dockerfile
FROM hashicorp/terraform:1.7

# Set working directory
WORKDIR /terraform

# Set project identifier for state management
ENV TERRAFORM_PROJECT=database-init

# Copy Terraform configuration files from database-init directory
COPY database-init/ .

# Copy the init script
COPY init-terraform.sh /terraform/init-terraform.sh
RUN chmod +x /terraform/init-terraform.sh

# Create entrypoint script
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'set -e' >> /entrypoint.sh && \
    echo 'echo "ðŸš€ Starting Database Initialization"' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# 1. Initialize Terraform backend' >> /entrypoint.sh && \
    echo 'echo "ðŸ”§ Initializing Terraform backend..."' >> /entrypoint.sh && \
    echo './init-terraform.sh' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# 2. Plan the migration' >> /entrypoint.sh && \
    echo 'echo "ï¿½ Planning database migration..."' >> /entrypoint.sh && \
    echo 'terraform plan -out=database-init.tfplan' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# 3. Apply the changes' >> /entrypoint.sh && \
    echo 'echo "ðŸš€ Applying database migration..."' >> /entrypoint.sh && \
    echo 'terraform apply database-init.tfplan' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo 'echo "âœ… Database migration completed successfully!"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Set entrypoint
ENTRYPOINT ["/entrypoint.sh"]
