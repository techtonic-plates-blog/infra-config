# Database Initialization Dockerfile
FROM hashicorp/terraform:1.7

# Install PostgreSQL client for testing connections
RUN apk add --no-cache postgresql-client

# Set working directory
WORKDIR /terraform

# Copy Terraform configuration files from database-init directory
COPY database-init/ .

# Initialize Terraform
RUN terraform init

# Create entrypoint script
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'set -e' >> /entrypoint.sh && \
    echo 'echo "🚀 Starting Database Initialization"' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Validate required environment variables' >> /entrypoint.sh && \
    echo 'required_vars="TF_VAR_postgres_host TF_VAR_postgres_password TF_VAR_debezium_user TF_VAR_debezium_pass"' >> /entrypoint.sh && \
    echo 'for var in $required_vars; do' >> /entrypoint.sh && \
    echo '    if [ -z "$(eval echo \$$var)" ]; then' >> /entrypoint.sh && \
    echo '        echo "❌ Error: Environment variable $var is not set"' >> /entrypoint.sh && \
    echo '        exit 1' >> /entrypoint.sh && \
    echo '    fi' >> /entrypoint.sh && \
    echo 'done' >> /entrypoint.sh && \
    echo 'echo "✅ Environment variables validated"' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Test PostgreSQL connection' >> /entrypoint.sh && \
    echo 'echo "🔍 Testing PostgreSQL connection..."' >> /entrypoint.sh && \
    echo 'PGPASSWORD=$TF_VAR_postgres_password psql -h $TF_VAR_postgres_host -U postgres -d postgres -c "SELECT version();" > /dev/null' >> /entrypoint.sh && \
    echo 'echo "✅ PostgreSQL connection successful"' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Plan and apply Terraform' >> /entrypoint.sh && \
    echo 'echo "📊 Planning database initialization..."' >> /entrypoint.sh && \
    echo 'terraform plan -out=database-init.tfplan' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo 'echo "🚀 Applying database initialization..."' >> /entrypoint.sh && \
    echo 'terraform apply database-init.tfplan' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo 'echo "✅ Database initialization completed successfully!"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Set entrypoint
ENTRYPOINT ["/entrypoint.sh"]
